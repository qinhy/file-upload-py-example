<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chunked File Upload to S3</title>
</head>
<body>

<input type="file" id="fileInput" />
<button onclick="startUpload()">Upload</button>
<div id="s3status"></div>
<div id="status"></div>

<script>
    async function startUpload() {
        const fileInput = document.getElementById('fileInput');
        if (fileInput.files.length === 0) {
            alert("Please select a file.");
            return;
        }

        const file = fileInput.files[0];
        filename = file.name;

        // Start the multipart upload to get an upload_id

        const formData = new FormData();
        formData.append('filename', filename);
        formData.append('filesize', file.size);
        const startResponse = await fetch('/start_upload/', {
            method: 'POST',
            body: formData
        }).then(res => res.json());

        var uploadId = startResponse.upload_id;
        var chunkSize = startResponse.chunk_size;
        var currentChunk = startResponse.chunk_number;
        var totalChunks = startResponse.total_chunks;

        document.getElementById('s3status').innerText =
                    `Upload initiated. Upload ID: [${uploadId}]`;
        // Start uploading chunks
        uploadChunk(file, chunkSize, currentChunk, totalChunks);
    }

    async function uploadChunk(file, chunkSize, chunkNumber, totalChunks) {
        if (chunkNumber >= totalChunks) {
            alert('Upload completed successfully!');
            return;
        }

        const start = chunkNumber * chunkSize;
        const end = Math.min(start + chunkSize, file.size);
        const blob = file.slice(start, end);

        const formData = new FormData();
        formData.append('file', blob);
        formData.append('filename', filename);

        try {
            const response = await fetch('/upload_chunk/', {
                method: 'POST',
                body: formData
            }).then(res => res.json());

            document.getElementById('status').innerText = 
                `Uploaded chunk ${chunkNumber + 1} of ${totalChunks}`;

            // Upload the next chunk
            uploadChunk(file, chunkSize, chunkNumber+1, totalChunks);
        } catch (error) {
            console.error('Error uploading chunk:', error);
            alert(`Failed to upload chunk ${chunkNumber + 1}. Please try again.`);
        }
    }
</script>

</body>
</html>
