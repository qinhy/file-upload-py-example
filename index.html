<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chunked File Upload to S3</title>
</head>
<body>

<input type="file" id="fileInput" />
<button onclick="startUpload()">Upload</button>
<div id="s3status"></div>
<div id="status"></div>

<script>
    const chunkSize = 5 * 1024 * 1024; // 5MB per chunk
    let currentChunk = 0;
    let uploadId = null;
    let totalChunks = 0;
    let filename = "";

    async function startUpload() {
        const fileInput = document.getElementById('fileInput');
        if (fileInput.files.length === 0) {
            alert("Please select a file.");
            return;
        }

        const file = fileInput.files[0];
        filename = file.name;
        totalChunks = Math.ceil(file.size / chunkSize);

        // Start the multipart upload to get an upload_id

        const formData = new FormData();
        formData.append('filename', filename);
        formData.append('total_chunks', totalChunks);
        const startResponse = await fetch('/start_upload/', {
            method: 'POST',
            body: formData
        }).then(res => res.json());

        uploadId = startResponse.upload_id;
        currentChunk = startResponse.chunk_number;

        document.getElementById('s3status').innerText = `Upload initiated. Upload ID: [${uploadId}]`;
        // Start uploading chunks
        uploadChunk(file, currentChunk);
    }

    async function uploadChunk(file, chunkNumber) {
        if (chunkNumber >= totalChunks) {
            alert('Upload completed successfully!');
            return;
        }

        const start = chunkNumber * chunkSize;
        const end = Math.min(start + chunkSize, file.size);
        const blob = file.slice(start, end);

        const formData = new FormData();
        formData.append('file', blob);
        formData.append('filename', filename);

        try {
            const response = await fetch('/upload_chunk/', {
                method: 'POST',
                body: formData
            }).then(res => res.json());

            document.getElementById('status').innerText = `Uploaded chunk ${chunkNumber + 1} of ${totalChunks}`;

            // Upload the next chunk
            uploadChunk(file, chunkNumber + 1);
        } catch (error) {
            console.error('Error uploading chunk:', error);
            alert(`Failed to upload chunk ${chunkNumber + 1}. Please try again.`);
        }
    }
</script>

</body>
</html>
